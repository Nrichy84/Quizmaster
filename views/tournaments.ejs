<section class="tournaments">
  <h1>
    <% if (type === 'free') { %>
      J√°t√©kp√©nzes versenyek
    <% } else if (type === 'freeroll') { %>
      Freeroll versenyek
    <% } else if (type === 'buyin') { %>
      Buy-in versenyek
    <% } else { %>
      Versenyek
    <% } %>
  </h1>

  <% if (tournaments.length === 0) { %>
    <p>Nincs el√©rhet≈ë verseny ebben a kateg√≥ri√°ban.</p>
  <% } else { %>
    <div class="tournament-box">
      <table>
        <thead>
          <tr>
            <th>N√©v</th>
            <th>T√≠pus</th>
            <th>Kezd√©s</th>
            <th>Buy-in</th>
            <th>Prize pool</th>
            <th>M≈±velet</th>
          </tr>
        </thead>
        <tbody>
 <% tournaments.forEach(t => { %>
  <% const alreadyJoined = joinedIds.includes(t.id); %>
  <tr>
    <td><%= t.name %></td>
    <td><%= t.type %></td>
    <td><%= t.start_time %></td>
    <td><%= t.entry_fee %></td>
    <td><%= t.computed_prize || 0 %></td>
    <td>
      <button
  class="btn join-btn <%= alreadyJoined || t.isExpired ? 'joined' : '' %>"
  data-id="<%= t.id %>"
  <%= alreadyJoined || t.isExpired ? 'disabled' : '' %>>
  <%= t.isExpired ? 'Lek√©sted' : (alreadyJoined ? 'Csatlakozva' : 'Csatlakoz√°s') %>
</button>

      <a href="/lobby/<%= t.id %>" class="btn lobby-btn <%= alreadyJoined ? '' : 'hidden' %>">Lobby megnyit√°sa</a>
    </td>
  </tr>
<% }) %>

</tbody>
      </table>
    </div>
  <% } %>
</section>

<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.join-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-id');

      fetch(`/tournaments/${id}/join`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          if (data.ok) {
            btn.textContent = 'Csatlakozva';
            btn.classList.add('joined');
            btn.disabled = true;

            // üí∞ Egyenleg friss√≠t√©se az oldalon
  if (data.newBalance !== undefined) {
    const balanceEl = document.querySelector('#user-balance');
    if (balanceEl) balanceEl.textContent = data.newBalance;
  }

            // Mutatjuk a lobby gombot
            const lobbyBtn = btn.parentElement.querySelector('.lobby-btn');
            if (lobbyBtn) lobbyBtn.classList.remove('hidden');
          } else if (data.alreadyJoined) {
            btn.textContent = 'M√°r csatlakozt√°l';
            btn.disabled = true;
          } else {
            alert(data.error || 'Hiba t√∂rt√©nt a csatlakoz√°s sor√°n.');
          }
        })
        .catch(() => alert('Nem siker√ºlt csatlakozni a szerverhez.'));
    });
  });
});
</script>

<script>
// ‚úÖ √âl≈ë friss√≠t√©s: minden m√°sodpercben ellen≈ërzi a versenyeket
function checkExpiredTournaments() {
  document.querySelectorAll('tr').forEach(row => {
    const dateCell = row.querySelector('td:nth-child(3)'); // 3. oszlop: Kezd√©s
    const button = row.querySelector('.join-btn');
    if (!dateCell || !button) return;

    const startTimeStr = dateCell.textContent.trim().replace(' ', 'T');
    const startTime = new Date(startTimeStr);
    const now = new Date();

    if (now >= startTime && !button.disabled) {
      button.disabled = true;
      button.textContent = 'Lek√©sted';
      button.classList.add('joined');
      console.log(`‚è∞ ${startTimeStr} verseny elindult ‚Üí gomb tiltva`);
    }
  });
}

// ‚úÖ Ind√≠t√°s, amint az oldal bet√∂lt≈ëd√∂tt
document.addEventListener('DOMContentLoaded', () => {
  setInterval(checkExpiredTournaments, 1000); // m√°sodpercenk√©nt
});
</script>