<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Kv√≠z ‚Äì Ov√°lis p√≥kerasztal anim√°ci√≥kkal</title>
<style>
  :root{
    --table-green-1:#0e5f35;
    --table-green-2:#094525;
    --felt:#0a5a31;
    --chip:#f1c40f;
    --chip-text:#1b1b1b;
    --player:#218c3c;
    --player-out:#666;
    --me-ring:gold;
  }
  html,body{margin:0;padding:0;background:#1b1b1b;color:#ecf0f1;font-family:Arial,Helvetica,sans-serif;}
  header{padding:10px 12px;text-align:center;background:#c0392b;}
  header small{display:block;color:#f1c40f}
  #table{
    width:min(92vw,1000px); height:min(60vw,520px);
    margin:18px auto; position:relative; overflow:hidden;
    background: radial-gradient(circle at 50% 45%, var(--table-green-1), var(--table-green-2) 70%);
    border-radius:50% / 35%;
    box-shadow: 0 25px 60px rgba(0,0,0,.55), inset 0 0 80px rgba(0,0,0,.6);
    border:8px solid #3a2317;
  }

  /* K√∂zponti UI ‚Äì k√©rd√©s, v√°lasz, inf√≥sor */
  #centerUI{
    position:absolute; inset:20% 18% 18% 18%; display:flex; flex-direction:column; justify-content:space-between; align-items:center; text-align:center;
  }
  #question{font-size:1.2rem; line-height:1.35; margin:0 0 .6rem;}
  #answers{display:grid; grid-template-columns:1fr 1fr; gap:.5rem; width:min(520px,100%);}
  .answer-btn{
    padding:.6rem .9rem; border:none; border-radius:10px; background:#2d7bd1; color:#fff; font-size:1rem; cursor:pointer;
    transition:transform .1s ease, background .2s ease;
  }
  .answer-btn:hover{background:#1abc9c; transform:translateY(-1px);}
  .answer-btn:disabled{opacity:.6; cursor:not-allowed}

  #infoBar{
    display:grid; grid-template-columns:repeat(4,auto); gap:1rem; align-items:center; justify-content:center; margin-top:.6rem; font-weight:bold;
  }
  #infoBar .pill{
    background:rgba(0,0,0,.25); padding:.35rem .6rem; border-radius:999px; box-shadow:inset 0 0 0 2px rgba(255,255,255,.06);
  }

  /* J√°t√©kosok a peremen */
  .player{
    width:72px; height:72px; position:absolute; border-radius:50%; background:var(--player);
    display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:6px; box-sizing:border-box;
    font-size:.8rem; line-height:1.1; user-select:none;
    box-shadow:0 3px 10px rgba(0,0,0,.45), inset 0 0 0 2px rgba(255,255,255,.08);
    transition:transform .2s ease, opacity .2s ease, background .2s ease;
  }
  .player.me{outline:3px solid var(--me-ring); box-shadow:0 0 10px var(--me-ring), inset 0 0 0 2px rgba(255,255,255,.08);}
  .player.out{background:var(--player-out); opacity:.55; filter:grayscale(.3)}
  .player .name{font-weight:bold}
  .player .pts{font-size:.75rem; opacity:.9}

  /* Zsetonok (anim√°ci√≥s elemek) */
  .chip{
    position:absolute; width:28px; height:28px; border-radius:50%;
    background:radial-gradient(circle at 35% 35%, #ffe27a, var(--chip));
    box-shadow:0 3px 8px rgba(0,0,0,.45), inset 0 0 0 3px rgba(0,0,0,.15);
    display:flex; align-items:center; justify-content:center;
    color:var(--chip-text); font-weight:bold; font-size:.72rem;
    transform:translate(-50%,-50%);
    transition:left .6s ease, top .6s ease, opacity .3s ease;
    pointer-events:none; z-index:20;
  }

  /* Villogtat√°s gy≈ëztesen */
  @keyframes winnerFlash {
    0%, 100% { box-shadow:0 0 0 0 rgba(255,255,255,.0), 0 0 10px 2px rgba(80,255,120,.0) inset; }
    50% { box-shadow:0 0 18px 3px rgba(80,255,120,.65), 0 0 14px 4px rgba(80,255,120,.55) inset; }
  }
  .flash { animation:winnerFlash .45s ease-in-out 4; }

  /* K√∂z√©ps≈ë ‚Äûpot‚Äù c√©lpont */
  #potCenter{
    position:absolute; left:50%; top:48%; transform:translate(-50%,-50%);
    width:120px; height:120px; border-radius:50%;
    border:2px dashed rgba(255,255,255,.25);
    display:flex; align-items:center; justify-content:center;
    color:#f9d17a; font-weight:bold; pointer-events:none; opacity:.9;
  }

  /* V√°lasz st√°tusz */
  #roundMsg{
    position:absolute; bottom:8px; left:50%; transform:translateX(-50%);
    font-style:italic; opacity:.9; font-size:.95rem;
  }
</style>
</head>
<body>
  

  <div id="table">
    <!-- k√∂zponti c√©l a zsetonoknak -->
    <div id="potCenter">POT</div>

    <!-- k√∂zponti UI -->
    <div id="centerUI">
      <div>
        <div id="question">Bet√∂lt√©s‚Ä¶</div>
        <div id="answers"></div>
      </div>
  
      <!-- T√©t emel√©s visszasz√°ml√°l√≥ -->
<div id="raise-timer" class="raise-timer">K√∂vetkez≈ë t√©t emel√©s: 10:00</div>

      <div id="infoBar">
        <div class="pill">‚è±Ô∏è Id≈ë: <span id="timer">15</span>s</div>
        <div class="pill">üé≤ T√©t: <span id="stake">10</span></div>
        <div class="pill">üí∞ Pot: <span id="pot">0</span></div>
        <div class="pill">üìä Helyez√©sed: <span id="rank">-</span></div>
      </div>
    </div>

    <div id="roundMsg"></div>
  </div>



<script src="/socket.io/socket.io.js"></script>
<script>
  // Szerver √°ltal adott adatok
  const username   = "<%= user.username %>";
  const tournament = <%- JSON.stringify(tournament) %>;

  // DOM elemek
  const $table      = document.getElementById('table');
  const $question   = document.getElementById('question');
  const $answers    = document.getElementById('answers');
  const $timer      = document.getElementById('timer');
  const $stakeEl    = document.getElementById('stake');
  const $potEl      = document.getElementById('pot');
  const $rankEl     = document.getElementById('rank');
  const $roundMsg   = document.getElementById('roundMsg');
  const $potCenter  = document.getElementById('potCenter');
  const $raiseTimerEl = document.getElementById('raise-timer');

  let players = [];          // { username, points, active, id }
  let currentQuestion = null;
  let answered = false;
  let stake = 10;
  let pot   = 0;
  let tInterval = null;

  let raiseTimer = 600;
  let raiseCountdownInterval = null;
  let stakeInterval = null;

  function fmt(n){ return Math.round(n); }

  // ===== Socket inicializ√°l√°s =====
  const socket = io({
    query: {
      username,
      tournamentId: tournament.id
    }
  });

  socket.on("connect", () => {
    console.log("üîå Socket csatlakozva:", socket.id);
  });

  // ====== J√°t√©kosok kezel√©se + kirajzol√°s ======
  function syncPlayers(list){
    // list: [{ username, points, active }]
    const byName = new Map(players.map(p => [p.username, p]));
    let nextId = 1;
    players = list.map(p => {
      const existing = byName.get(p.username);
      if (existing) {
        existing.points = p.points;
        existing.active = p.active;
        existing.id = nextId++;
        return existing;
      }
      return {
        id: nextId++,
        username: p.username,
        points: p.points,
        active: p.active
      };
    });
    renderPlayers();
    updateInfo();
  }

  function renderPlayers(){
    [...$table.querySelectorAll('.player')].forEach(n => n.remove());

    const W = $table.clientWidth;
    const H = $table.clientHeight;
    const cx = W / 2;
    const cy = H / 2;
    const rx = W / 2 - 70;
    const ry = H / 2 - 40;
    const N  = players.length || 1;

    players.forEach((p, i) => {
      const angle = (2 * Math.PI * i / N) - Math.PI/2;
      const x = cx + rx * Math.cos(angle);
      const y = cy + ry * Math.sin(angle);

      const div = document.createElement('div');
      div.className = 'player'
        + (p.username === username ? ' me' : '')
        + (!p.active ? ' out' : '');
      div.style.left = (x - 36) + 'px';
      div.style.top  = (y - 36) + 'px';
      div.dataset.pid = p.id;
      div.innerHTML = `
        <div class="name">${p.username}</div>
        <div class="pts">${fmt(p.points)}</div>
      `;
      $table.appendChild(div);
    });
  }

  function getPlayerByName(name){
    return players.find(p => p.username === name);
  }

  function getPlayerCenter(pid){
    const el = [...$table.querySelectorAll('.player')].find(d => +d.dataset.pid === pid);
    if (!el) return { x: $table.clientWidth/2, y:$table.clientHeight/2 };
    const rect  = el.getBoundingClientRect();
    const tRect = $table.getBoundingClientRect();
    return {
      x: rect.left - tRect.left + rect.width/2,
      y: rect.top  - tRect.top  + rect.height/2
    };
  }

  function getPotCenter(){
    const rect  = $potCenter.getBoundingClientRect();
    const tRect = $table.getBoundingClientRect();
    return {
      x: rect.left - tRect.left + rect.width/2,
      y: rect.top  - tRect.top  + rect.height/2
    };
  }

  function makeChip(x,y,label){
    const c = document.createElement('div');
    c.className = 'chip';
    c.style.left = x + 'px';
    c.style.top  = y + 'px';
    c.textContent = label;
    $table.appendChild(c);
    return c;
  }

  function animateChipsToCenterFromMap(payMap){
    return new Promise(resolve => {
      const center = getPotCenter();
      const chips = [];
      payMap.forEach((amount, pid) => {
        const from = getPlayerCenter(pid);
        const chip = makeChip(from.x, from.y, amount);
        requestAnimationFrame(() => {
          chip.style.left = center.x + 'px';
          chip.style.top  = center.y + 'px';
        });
        chips.push(chip);
      });
      setTimeout(() => {
        chips.forEach(ch => ch.remove());
        resolve();
      }, 700);
    });
  }

  function animateChipsFromCenterToWinners(winners, share){
    return new Promise(resolve => {
      if (!winners.length || share <= 0) return resolve();
      const center = getPotCenter();
      const chips = winners.map(w => {
        const chip = makeChip(center.x, center.y, share);
        return { chip, pid: w.id };
      });
      requestAnimationFrame(() => {
        chips.forEach(({chip,pid}) => {
          const to = getPlayerCenter(pid);
          chip.style.left = to.x + 'px';
          chip.style.top  = to.y + 'px';
        });
      });
      setTimeout(() => {
        chips.forEach(({chip}) => chip.remove());
        resolve();
      }, 750);
    });
  }

  function flashWinners(winners){
    winners.forEach(w => {
      const el = [...$table.querySelectorAll('.player')]
        .find(d => +d.dataset.pid === w.id);
      if (el) {
        el.classList.add('flash');
        setTimeout(() => el.classList.remove('flash'), 1800);
      }
    });
  }

  function updateInfo(){
    $stakeEl.textContent = stake;
    $potEl.textContent   = fmt(pot);

    const actives = players.filter(p => p.active)
                           .sort((a,b) => b.points - a.points);
    const me = players.find(p => p.username === username);
    const meIdx = actives.findIndex(p => p.username === username);

    $rankEl.textContent =
      me && meIdx >= 0
        ? `${meIdx+1} / ${actives.length}`
        : `- / ${actives.length || 0}`;

    $table.querySelectorAll('.player').forEach(div => {
      const pid = +div.dataset.pid;
      const p = players.find(x => x.id === pid);
      if (!p) return;
      div.classList.toggle('out', !p.active);
      const pts = div.querySelector('.pts');
      if (pts) pts.textContent = fmt(p.points);
    });
  }

  function setButtonsEnabled(on){
    [...$answers.querySelectorAll('button')].forEach(b => b.disabled = !on);
  }

  function startQuestionTimer(){
    if (tInterval) clearInterval(tInterval);
    let t = 15;
    $timer.textContent = t;
    tInterval = setInterval(() => {
      if (t > 0) {
        t--;
        $timer.textContent = t;
      } else {
        clearInterval(tInterval);
        if (!answered && currentQuestion) {
          console.log("‚è∞ Id≈ë lej√°rt, automatikus passz");
          sendAnswer(null);
        }
      }
    }, 1000);
  }

  // ====== T√©t dupl√°z√≥ (csak vizu√°l, mint eddig) ======
  function updateRaiseTimer(){
    const m = Math.floor(raiseTimer / 60);
    const s = (raiseTimer % 60).toString().padStart(2,'0');
    if ($raiseTimerEl)
      $raiseTimerEl.textContent = `K√∂vetkez≈ë t√©t emel√©s: ${m}:${s}`;
  }

  function startStakeDoubler(){
    if (stakeInterval) clearInterval(stakeInterval);
    if (raiseCountdownInterval) clearInterval(raiseCountdownInterval);
    raiseTimer = 600;
    updateRaiseTimer();

    stakeInterval = setInterval(() => {
      stake *= 2;
      updateInfo();
      raiseTimer = 600;
      if ($raiseTimerEl){
        $raiseTimerEl.style.color = '#ff4040';
        setTimeout(() => $raiseTimerEl.style.color = '#ffd700', 800);
      }
    }, 10 * 60 * 1000);

    raiseCountdownInterval = setInterval(() => {
      if (raiseTimer > 0){
        raiseTimer--;
        updateRaiseTimer();
      }
    }, 1000);
  }

  // ===== SOCKET esem√©nyek =====

  socket.on("currentPlayers", (list) => {
    console.log("üë• currentPlayers:", list);
    syncPlayers(list);
  });

  socket.on("newQuestion", (q) => {
    console.log("üì© √öj k√©rd√©s:", q);
    currentQuestion = q;
    answered = false;

    $question.textContent = q.q;
    $roundMsg.textContent = "";
    $answers.innerHTML = "";

    (q.a || []).forEach((ans, idx) => {
      const btn = document.createElement('button');
      btn.className = 'answer-btn';
      btn.textContent = ans;
      btn.onclick = () => sendAnswer(idx);
      $answers.appendChild(btn);
    });

    setButtonsEnabled(true);
    startQuestionTimer();
  });

  socket.on("playerResult", async (data) => {
    console.log("üèÜ playerResult:", data);
    if (!currentQuestion) return;

    // Szerver m√°r levonta a t√©tet √©s friss√≠tette a pontokat -> sync
    stake = data.stake;
    pot   = data.pot;
    syncPlayers(data.players);

    // Befizet√©s vizu√°lis anim√°ci√≥ ‚Äì felt√©telezz√ºk, hogy minden akt√≠v befizetett
    const payMap = new Map();
    players.forEach(p => {
      if (!p.active) return;
      const pid = p.id;
      // csak vizu√°lis: t√©t √∂sszege
      payMap.set(pid, stake);
    });

    await animateChipsToCenterFromMap(payMap);

    // Nyertesek
    const winners = (data.results || [])
      .filter(r => r.correct)
      .map(r => getPlayerByName(r.username))
      .filter(Boolean);

    if (winners.length){
      await animateChipsFromCenterToWinners(winners, data.share || 0);
      flashWinners(winners);
      $roundMsg.textContent = "Helyes v√°lasz! Nyerem√©ny kiosztva.";
    } else {
      $roundMsg.textContent = "Senki sem tal√°lta el, a pot bent marad.";
    }

    // Helyes v√°lasz ki√≠r√°sa
    if (typeof data.correctIndex === "number" && currentQuestion.a) {
      const correctText = currentQuestion.a[data.correctIndex];
      $question.textContent = `${currentQuestion.q}  ‚úÖ Helyes v√°lasz: ${correctText}`;
    }

    setButtonsEnabled(false);
  });

 socket.on("gameOver", (data) => {
    console.log("üèÅ V√©geredm√©ny:", data);

    const overlay = document.createElement("div");
    overlay.style.position = "fixed";
    overlay.style.inset = "0";
    overlay.style.background = "rgba(0,0,0,0.9)";
    overlay.style.color = "#fff";
    overlay.style.display = "flex";
    overlay.style.flexDirection = "column";
    overlay.style.alignItems = "center";
    overlay.style.justifyContent = "center";
    overlay.style.fontSize = "1.3rem";
    overlay.style.zIndex = "9999";

    overlay.innerHTML = `<h2>üèÜ V√©geredm√©ny</h2>`;

    // ---- ADATOK NORMALIZ√ÅL√ÅSA ----
    const ranked  = data.ranked || [];         // [{ username, points }]
    let prizes    = data.prizes || {};         // { username: amount } ‚Äì ha a szerver √≠gy k√ºldi
    const winners = data.winners || [];        // [ "n√©v", ... ] ‚Äì ha √≠gy k√ºldi
    const rewardEach = data.rewardEach || 0;   // ha minden nyertes ugyanannyit kap
    const singleWinner = data.winner;          // ha csak 1 gy≈ëztes van
    const singleReward = data.reward || 0;     // annak az √∂sszege

    // Ha a prizes √ºres VAGY csak 0-k vannak benne, pr√≥b√°ljuk meg a t√∂bbib≈ël fel√©p√≠teni
    const prizeValues   = Object.values(prizes);
    const prizesMissing = prizeValues.length === 0 || prizeValues.every(v => !v);

    if (prizesMissing) {
      prizes = {};

      // T√∂bb nyertes: winners + rewardEach
      if (Array.isArray(winners) && winners.length && rewardEach > 0) {
        winners.forEach(name => prizes[name] = rewardEach);
      }
      // Egy nyertes: winner + reward
      else if (singleWinner && singleReward > 0) {
        prizes[singleWinner] = singleReward;
      }
    }

    // ---- Ranglista ki√≠r√°sa ----
    ranked.forEach((p, i) => {
      const medal = i === 0 ? "ü•á" : i === 1 ? "ü•à" : i === 2 ? "ü•â" : "üèÖ";
      const div = document.createElement("div");
      const prize = prizes[p.username] || 0;
      div.textContent = `${medal} ${i + 1}. hely: ${p.username} (${p.points} pont) ‚Äì +${prize} zseton`;
      overlay.appendChild(div);
    });

    // ---- Saj√°t nyerem√©ny ----
    const myPrize = prizes[username] || 0;
    const myRankIndex = ranked.findIndex(p => p.username === username);
    const myRankText = myRankIndex >= 0 ? (myRankIndex + 1) : "-";

    const prizeText = document.createElement("div");
    prizeText.style.marginTop = "20px";
    prizeText.style.fontSize = "1.4rem";
    prizeText.style.fontWeight = "bold";
    prizeText.style.color = myPrize > 0 ? "#FFD700" : "#ccc";
    prizeText.textContent =
      myPrize > 0
        ? `üí∞ Nyerem√©nyed: ${myPrize.toLocaleString()} zseton (üèÖ ${myRankText}. hely)`
        : "üòî Sajnos most nem nyert√©l.";
    overlay.appendChild(prizeText);

    const backBtn = document.createElement("button");
    backBtn.textContent = "üè† Vissza a f≈ëoldalra";
    backBtn.style.marginTop = "25px";
    backBtn.style.padding = "10px 20px";
    backBtn.style.background = "#e67e22";
    backBtn.style.border = "none";
    backBtn.style.borderRadius = "8px";
    backBtn.style.cursor = "pointer";
    backBtn.onclick = () => window.location.href = "/tournaments";
    overlay.appendChild(backBtn);

    document.body.appendChild(overlay);

    // ‚ö† FIGYELEM: ha a szerver M√ÅR j√≥v√°√≠rja a nyerem√©nyt az adatb√°zisban,
    // akkor ezt NYUGODTAN KIKOMMENTELHETED, hogy ne dupl√°n √≠rja j√≥v√°.
    /*
    if (myPrize > 0) {
      fetch("/api/addwinnings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: username, amount: myPrize })
      })
        .then(res => res.json())
        .then(data => console.log("üíæ Nyerem√©ny elmentve:", data))
        .catch(err => console.error("‚ùå Hiba a nyerem√©ny ment√©s√©n√©l:", err));
    }
    */
  });

  function sendAnswer(answerIndex){
    if (answered || !currentQuestion) return;
    answered = true;
    setButtonsEnabled(false);

    console.log("üì§ V√°lasz k√ºld√©se:", answerIndex);
    socket.emit("playerAnswer", { answerIndex });
  }

  document.addEventListener("DOMContentLoaded", () => {
    startStakeDoubler();
  });
socket.on("youAreOut", (data) => {
    if (data.username !== username) return; // m√°snak sz√≥lt

    // Meg√°ll√≠tjuk a socketet
    socket.disconnect();

    // Kiest√©l overlay
    const overlay = document.createElement("div");
    overlay.style.position = "fixed";
    overlay.style.inset = "0";
    overlay.style.background = "rgba(0,0,0,0.9)";
    overlay.style.color = "#fff";
    overlay.style.display = "flex";
    overlay.style.flexDirection = "column";
    overlay.style.alignItems = "center";
    overlay.style.justifyContent = "center";
    overlay.style.fontSize = "1.3rem";
    overlay.style.zIndex = "9999";

    overlay.innerHTML = `
        <h2>‚ùå Kiest√©l a j√°t√©kb√≥l!</h2>
        <p>üìä Helyez√©sed: <b>${data.rank} / ${data.total}</b></p>
        <p>üí∞ Nyerem√©nyed: <b>${data.prize}</b> zseton</p>
    `;

    const backBtn = document.createElement("button");
    backBtn.textContent = "üè† Vissza a f≈ëoldalra";
    backBtn.style.marginTop = "25px";
    backBtn.style.padding = "10px 20px";
    backBtn.style.background = "#e67e22";
    backBtn.style.border = "none";
    backBtn.style.borderRadius = "8px";
    backBtn.style.cursor = "pointer";
    backBtn.onclick = () => window.location.href = "/tournaments";

    overlay.appendChild(backBtn);

    document.body.appendChild(overlay);
});
let breakOverlay = null;
let breakTimerInterval = null;

socket.on("breakStart", ({ secondsLeft }) => {
  console.log("‚è∏ Sz√ºnet indul, m√°sodpercek:", secondsLeft);

  if (!breakOverlay) {
    breakOverlay = document.createElement("div");
    breakOverlay.id = "breakOverlay";
    Object.assign(breakOverlay.style, {
      position: "fixed",
      inset: "0",
      background: "rgba(0,0,0,0.9)",
      color: "#fff",
      display: "flex",
      flexDirection: "column",
      alignItems: "center",
      justifyContent: "center",
      fontSize: "1.6rem",
      zIndex: "9999",
    });

    breakOverlay.innerHTML = `
      <div style="font-size:2rem; margin-bottom:10px;">‚è∏ Sz√ºnet van!</div>
      <div style="margin-bottom:10px;">A j√°t√©k a SZ√úNET ut√°n folytat√≥dik.</div>
      <div id="breakTimer" style="font-size:1.4rem; font-weight:bold;"></div>
    `;

    document.body.appendChild(breakOverlay);
  } else {
    breakOverlay.style.display = "flex";
  }

  // v√°laszgombok tilt√°sa
  setButtonsEnabled(false);

  let t = secondsLeft;
  const timerLabel = breakOverlay.querySelector("#breakTimer");

  if (breakTimerInterval) clearInterval(breakTimerInterval);

  function updateTimer() {
    const m = Math.floor(t / 60);
    const s = (t % 60).toString().padStart(2, "0");
    timerLabel.textContent = `H√°tral√©v≈ë sz√ºnet: ${m}:${s}`;
  }

  updateTimer();

  breakTimerInterval = setInterval(() => {
    t--;
    if (t < 0) {
      clearInterval(breakTimerInterval);
      return;
    }
    updateTimer();
  }, 1000);
});

socket.on("breakEnd", () => {
  console.log("‚ñ∂Ô∏è Sz√ºnet v√©ge");
  if (breakOverlay) breakOverlay.style.display = "none";
  setButtonsEnabled(true);
});
</script>
</body>
</html>
